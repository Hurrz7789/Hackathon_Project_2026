import csv
import os
import time
import subprocess # Needed to talk to GitHub
import random 
from datetime import datetime

# Temporary Mock Class
class SenseHat:
    def get_temperature(self):
        return random.uniform(15.0, 35.0) 
    def get_humidity(self):
        return random.uniform(30.0, 60.0)

sense = SenseHat()

# --- FOLDER CONFIGURATION ---
FOLDER_NAME = "logs"
FILE_NAME = os.path.join(FOLDER_NAME, "flora_logs.txt")

# Create the logs folder if it doesn't exist
if not os.path.exists(FOLDER_NAME):
    os.makedirs(FOLDER_NAME)

# Initialize the CSV file with headers
if not os.path.exists(FILE_NAME):
    with open(FILE_NAME, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(["Timestamp", "Temperature (C)", "Humidity (%)", "Status"])

def sync_to_github():
    """Tells the computer to upload the updated file to GitHub"""
    try:
        # We add the whole folder to catch the new file structure
        subprocess.run(["git", "add", "."], check=True)
        subprocess.run(["git", "commit", "-m", "Auto-update flora logs"], check=True)
        subprocess.run(["git", "push"], check=True)
        print("‚úÖ Successfully synced to GitHub!")
    except Exception as e:
        print(f"‚ùå GitHub sync failed: {e}")

def log_data():
    temp = round(sense.get_temperature(), 2)
    humidity = round(sense.get_humidity(), 2)
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # Threshold check
    status = "Optimal" if 8 <= temp <= 22 else "Hot"
    
    with open(FILE_NAME, mode='a', newline='') as file:
        writer = csv.writer(file)
        writer.writerow([timestamp, temp, humidity, status])
    
    print(f"üìù Logged: {timestamp} | {temp}C | {status}")
    
    # Sync to GitHub after writing the file
    sync_to_github()

# MAIN LOOP
if __name__ == "__main__":
    print("üåø FloraGuard is starting...")
    while True:
        log_data()
        print("Waiting 60 seconds...") # Shortened for testing
        time.sleep(60)







